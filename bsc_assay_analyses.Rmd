---
title: "Bush stone-curlew behaviour and performance analyes"
author: "Shoshana Rapley"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages
pacman::p_load(beepr, ggpubr, glmmTMB, janitor, performance, sjPlot, survival, readxl, )

pacman::p_load(adehabitatHR, amt, atlastools, beepr, ggmap, ggpubr, glmmTMB, gtools, janitor, lme4, move2, moveHMM, progressr, performance, pscl, SDLfilter, segclust2d, sf, sjPlot, solitude, suncalc, survival, survminer, readr, readxl, terra, tidyterra, tidyverse, wildlifeDI)

# Bird list excluding Daisy (returned to captivity) & Star (disease fate)
birds <- c("Briar", "Nutmeg", "Aurora", "Robin",
           "Iona", "Sage", "Koda", "Brook", "Clover",
           "Prem", "Rove", "Valentine", "Marmalade", "Wobbles")
```

# Introduction

This Markdown documents pre-release assays and post-release survival for translocated bush stone-curlews at Mt Rothwell, Victoria. 

We want to know if the pre-release assays (latency to reach food, vigilance and handling reponse) can be used to predict post-release performance , and thereby screen for suitable release candidates in future translocations. 

# Predictors

We undertook pre-release assays prior to release of the birds. The pre-release assays were:

* Latency to reach food
* Handling response
* Vigilance

## Latency

Latency to reach food is how long it took each bird, in seconds, to reach a plate of food provided as part of their normal husbandry, measured from when the plate was placed on the ground until the bird took the first mouthful. 

```{r latency data}
# Read in and clean up latency assay data
latency <- read_excel("Input/bsc assay data.xlsx", sheet =3) %>%
  clean_names() %>%
  # Select study birds
  filter(bird %in% birds) %>%
  # Filter to assay dates
  filter(date %in% c("2022-10-12", "2022-10-11")) %>%
  select(c("date", "bird", "reach", "latency_s")) %>%
  # Convert yes/no to 1/0
  mutate(reach = ifelse(reach == "Yes", 1, 0)) %>%
  rename(latency = latency_s) %>%
  # Add column for plotting 'did not reach'
  mutate(label = ifelse(is.na(latency), "DNR", "")) %>%
  # Convert latency NAs to zeros
  mutate(latency = ifelse(is.na(latency), 0, latency))

# Playing with alt latency scores
latency2 <- latency %>% group_by(bird) %>%
  summarise(latency = mean(latency))

# Plot latency by bird
ggplot(latency) + 
  geom_bar(aes(bird, latency, fill = as.character(date)), position = "dodge", stat = "identity")+
  geom_text(aes(y=600, x= bird, label = label), angle = 90, vjust = -0.5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= element_blank(), y = "Latency to reach food (seconds)")+
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_fill_manual(values = c("#881C00FF","#1BB6AFFF"), name = "Assay date")+
  theme_minimal()
```

## Handling response

Handling response is an ordinal variable assigned during processing, on a scale of 1:3:

1) Calm/still/log-pose
2) Moderate/slight kicking or struggling/soft calling or beak clacking
3) Extreme/upset/shrieking/growling

```{r handling}
# Read in handling data
handling <- read_excel("Input/bsc assay data.xlsx", sheet = 7) %>%
  clean_names() %>%
  rename(bird = identity) %>%
  # Filter to study birds
  filter(bird %in% birds) %>%
  # Filter to assay dates
  filter(date %in% c("2022-10-20"))

# Plot
ggplot(handling)+
  geom_bar(aes(score))+
  theme_minimal()
```

Interestingly, when there are repeat measures (post-release) the handling response stays the same; however, for now we are just interested in whether the pre-release assay values predict other post-release behaviours. 

### Vigilance

Vigilance is the proportion of time spent in vigilant behaviours (considered mutually exclusive from 'relaxed' behaviours). 

*Vigilant behaviours* were defined as:

* Alertness: standing but not relaxed, often startled into this pose from a more relaxed posture. May have a stiffer pose, holding neck extended or forward. May have flattened the feathers against the body. 
* Alert walk: walking with the neck stiffly extended parallel wit hthe ground. Feathers either fluffed up (held erect) or slimmed against body, as opposed to held loosely. 
* Head-bobbing: a rapid up/down movement of the head; used to communicate unease.
* Head-tilting: craning the head to the side to look above and around; possibly to check for danger (can be done in tandem with head-bobbing).
* Tail-wagging: a rapid side/side shake of the tail; used to communicate unease.
* Defensive display: holding the wings outstretched; often wings are rapidly extended which gives the impression of a black and white 'flash' of plumage.

*Relaxed behaviours* were defined as:

* Preening: actively cleaning self (i.e., running the beak along the feathers, rearranging plumage), or scratching (e.g. the face with the toes), or stretching (e.g. extending the leg and wing).
* Fluffing: a rapid erection and flattening of the feathers, often accompanied by a body and head shake. Often preceded by preening. 
* Standing: relaxed pose (in the absence of vigilant behaviours as defined above), feathers loose or lightly fluffed (as opposed to erect or flat against the body).
* Walking: stepping forward (in the absence of vigilant behaviours as defined above).
* sitting: either on tibiotarsus or fully on the ground; includes sleeping. 
* Eating: engaged in looking at, carrying, pecking, picking up, swallowing or breaking up food (or non food items that are being tested e.g. leaves). Can rapidly (second by second) change between eating and alertness. 

Read in the video assay data and calculate the time spent vigilant as a proportion of whole time. Some videos have sections where the bird is out of frame (noted in ethogram as 'Z'), so the proportion vigilant is the full minute minus the period of Z. 

```{r vigilance}
# Read in and tidy up video assays 
video <- read_excel("Input/bsc assay data.xlsx", sheet =4) %>%
  clean_names() %>%
  # Drop metadata columns
  select(-c("clip", "note")) %>%
  # Convert from wide to long
  pivot_longer(3:61, names_to = "second", values_to = "behaviour") %>%
  # Convert seconds into numeric
  mutate(second = as.numeric(str_remove(second, "x"))) %>%
  # Assign vigilance to 1 and not to 0
  mutate(vigilant = ifelse(behaviour %in% c("A","HT","HB","HBT","N","TW","D"), 1, 0)) %>%
  # Drop lines without recordings (primarily for Prem and Rove who had 10 second clips)
  na.omit()

# Calculate time spent vigilant
vigilance <- video %>%
  group_by(bird) %>%
  summarise(z = sum(grepl("Z", behaviour)),
            L = length(behaviour) - z,
            v = sum(vigilant),
            pv = v/L)

# Plot proportion of time spent vigilant by bird
ggplot(vigilance) + 
  geom_bar(aes(bird, pv), position = "dodge", stat = "identity")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= element_blank(), y = "Proportion of time spent vigilant")+
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  theme_minimal()
```

# Responses

The response variables are survival and persistence. 

I set the maximum persistence duration to 360 days, because this is the maximum time tracked across all groups (time elapsed between release and removal of GPS devices).

```{r survival}
# Read in survival data
survival <- read.csv("Input/survival.csv") %>%
  clean_names() %>%
  rename(bird = identity) %>%
  filter(bird %in% birds) %>%
  # Limit persistence value to minimum common tracked time of 360
  mutate(persist = ifelse(persist>360, 360, persist))
```

#### m1a: latency ~ survival

*Does latency to reach food predict survival?*

```{r m1}
# Combine survival and latency data
m1_data <- survival %>%
  select(c("bird", "persist", "to_90", "to_360")) %>%
  left_join(latency)
```

There are two levels of response for latency to reach food: 

1) Did the bird reach the food (yes/no)
2) How long did it take the bird to reach the food?

First we look at the distribution of responses of whether they reached the food with survival. 

```{r reach food}
# Survived to 90 days
mosaicplot(table(m1_data$to_90, m1_data$reach))

chisq.test(table(m1_data$to_90, m1_data$reach))

# Survived to 360 days
mosaicplot(table(m1_data$to_360, m1_data$reach))

chisq.test(table(m1_data$to_360, m1_data$reach))
```

The birds didn't reach the food on one third of occasions, but all birds reached the food at least once (out of two trials). From here on we'll just use the time to reach the food.

We use a binomial family glm because the response variable (survival) is binary.

```{r m1a}
# Drop DNRs
m1_data <- filter(m1_data, !label == "DNR")

# m1ai: Does latency to reach food predict survival? To 90 days.
## add random effect for bird
ggplot(m1_data)+
  geom_boxplot(aes(x= to_90, y=log(latency), group=to_90))+
  theme_minimal()

m1ai <- glmmTMB(to_90 ~ scale((latency)),
           data = m1_data,
           family = binomial)
summary(m1ai)

check_model(m1ai)

# m1aii: Does latency to reach food predict survival? To 360 days.
ggplot(m1_data)+
  geom_boxplot(aes(x= to_360, y=log(latency), group=to_360))+
  theme_minimal()

m1aii <- glmmTMB(to_360 ~ scale(log(latency)),
           data = m1_data,
           family = binomial)
summary(m1aii)

check_model(m1aii)

```

Remember to say cannot use random effects because issues with model convergence due to low sample size. Include comment on model performance sub optimal 



Ideally I should have used date as a random factor (because some two-thirds of the birds have two latency scores), but the model wasn't able to handle this and gave me an error that "negative log-likelihood is NaN at starting parameter values". 

Perhaps I should use a hurdle model - first did they reach the food and then how long it took to reach the food?

#### m1b: latency ~ persistence
*Does latency to reach food predict persistence?*

First, we check the distribution of the response variable (persistence) to select the appropriate glm model family. 

```{r persist}
hist(m1_data$persist)
hist(log(m1_data$persist))
```

The persistence values are duration (e.g. zero or higher) and have a right-skewed distribution; therefore a negative binomial regression model should be suitable.

```{r m1b}
# m1b: Does latency to reach food predict persistence?
ggplot(m1_data, aes(persist, log(latency)))+
  geom_point()+
  geom_smooth(method = "lm")+
  theme_minimal()

m1b <- glmmTMB(persist ~ scale(log(latency)) + (1|bird),
           data = m1_data)
summary(m1b)

check_model(m1b)
```

Weak evidence that latency predicts persistence. Aagain, should this be a hurdle (first reach then latency)?

#### m2a: handling response ~ survival
*Does handling response predict survival?*

```{r m2a}
# Handling and survival data
m2_data <- survival %>%
  select(c("bird", "persist", "to_90", "to_360")) %>%
  left_join(handling) %>%
  mutate(score = as_factor(score))

# Does handling response predict survival? To 90 days. 
mosaicplot(table(m2_data$to_90, m2_data$score))

chisq.test(table(m2_data$to_90, m2_data$score))

# Does handling response predict survival? To 360 days. 
mosaicplot(table(m2_data$to_360, m2_data$score))

chisq.test(table(m2_data$to_360, m2_data$score))
```

While there is no evidence for a prediction here (on the chi-squared test, keeping in mind low sample size) there are some interesting observations we can make: 1) Both birds with a handling score of 3 survived. 2) No birds with a handling score of 2 survived. Perhaps an intermediate strategy is suboptimal i.e., it's better to either commit to full camouflage or full flight, not the middle ground. Perhaps the middle ground is evidence of habituation, since both scores 1 and 3 can be considered a predator-response behaviour (flight or camouflage). 

#### m2b: handling response ~ persistence
*Does handling response predict persistence?*

Since handling score is categorical, we'll use ANOVA and chi-squared to compare frequencies. 

```{r m2b}
# Does handling response predict persistence?
ggplot(m2_data)+
  geom_boxplot(aes(score, persist, group = score))+
  theme_minimal()

m2b <- aov(persist ~ score,
           data = m2_data)
summary(m2b)
```

All the score 3 birds do well. 

Interestingly, the persistence time for score 2 individuals is pretty long (195 & 308 days) - which contradicts my earlier thoughts about score 2 being maladaptive. Instead, it looks like there are a range of score 1 individual persistence values.

Overall, there is no evidence that handling score predicts persistence. 

#### m3a: vigilance ~ survival
*Does vigilance predict survival?*

We use a binomial family glm because the response variable (survival) is binary.

```{r m3a}
# Join vigilance and survival data
m3_data <- survival %>%
  select(c("bird", "persist", "to_90", "to_360")) %>%
  left_join(vigilance)

# m3ai: Does vigilance predict survival? to 90 days 
ggplot(m3_data)+
  geom_boxplot(aes(to_90, pv))+
  labs(y = "Proportion of time spent vigilant")+
  theme_minimal()

m3ai <- glmmTMB(to_90 ~ pv,
           data = m3_data,
           family = binomial)
summary(m3ai)

# m3aii: Does vigilance predict survival? to 90 days 
ggplot(m3_data)+
  geom_boxplot(aes(to_360, pv))+
  labs(y = "Proportion of time spent vigilant")+
  theme_minimal()

m3aii <- glmmTMB(to_360 ~ pv,
           data = m3_data,
           family = binomial)
summary(m3aii)
```

No evidence that proportion of time spent vigilant predicts survival. 

#### m3b: vigilance ~ persistence
*Does vigilance predict persistence?*

As before, we use a negative binomial regression model because of the right-skewed persistence values. 

```{r m3b}
# m3b: Does vigilance predict persistence?
ggplot(m3_data, aes(persist, pv))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(y = "Proportion of time spent vigilant")+
  theme_minimal()

m3b <- glmmTMB(persist ~ pv,
           data = m3_data,
           family = nbinom2(link = "log"))
summary(m3b)
```

No relationship. Although most vigilant bird (Iona) survived full time period. 

That's all of the predictors against survival/persistence. Looks like none of the metrics predicted survival. But maybe we'll be able to predict sub-lethal effects or behaviours that might influence future survival and reproduction.




### Hazard rate

I also want to try using a survival analysis approach, since 'persistence' is a time-to-event response. 

First I plot the survival curve to see if the hazard rate is constant over time (although this is tough with n=13).

```{r hazard, eval=FALSE}
# Add every day for survival
birds2 <- setdiff(birds, c("Daisy", "Star"))
survival2 <- data.frame()

for(i in 1:length(birds2)){
  temp <- subset(survival, bird == birds2[i]) %>%
    mutate(start_date = as_date(start_date, format = "%d/%m/%Y"),
           end_date = as_date(end_date, format = "%d/%m/%Y"))

  temp2 <- data.frame(date = as_date(temp$start_date:as_date("2024-01-10"))) %>%
  mutate(bird = birds2[i],
         status = ifelse(date<temp$end_date, 1, 0),
         # Convert dates to numeric for use in Surv()
         time = date - as_date(temp$start_date))
  
  survival2 <- rbind(survival2, temp2)
}

survival3 <- left_join(survival2, latency2) %>%
  left_join(select(handling, c(bird, score))) %>%
  mutate(score = as_factor(score))

# Plot hazard rate 
plot(survfit(Surv(time, status) ~ 1, data = survival2))

summary(survfit(Surv(time, status) ~ 1, data = survival2))


test <- coxph(Surv(time, status) ~ scale(latency) + score, data = survival3)
summary(test)
plot_model()
plot_model(test, type = "pred")
```

The hazard rate is approximately linear (i.e., constant), so we should be able to use a Cox proportional hazard model rather than a parametric survival model. 



